<!doctype html><html lang=en dir=auto><head><meta name=google-site-verification content="qgixNnkm2LoCsgWFtvfJRVqnkpqtr1Xzc5YTPoCL2zc"><meta name=yandex-verification content="c25e903254c44b74"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Different ways to implement wrappers in Scala | Awethon's Page</title><meta name=keywords content="scala"><meta name=description content="The wrapper pattern (or the proxy pattern) is a useful way of adding extra logic to the methods of a class without changing it. It might be handy in scenarios where an application needs to be heavily instrumented and putting all the instrumentation in business logic will make code less readable. To be more specific, wrappers are useful for logging, metering, and tracing, but not limited to it. For example, it might be useful to set timeouts and retries in wrappers."><meta name=author content><link rel=canonical href=https://awethon.github.io/posts/scala-wrappers/><link href=/assets/css/stylesheet.min.d08f6c302eba3eaecd589684c093cecdfe7dfb8745a207401bd0583d3bb31837.css integrity="sha256-0I9sMC66Pq7NWJaEwJPOzf59+4dFogdAG9BYPTuzGDc=" rel="preload stylesheet" as=style><link rel=icon href=https://awethon.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://awethon.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://awethon.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://awethon.github.io/apple-touch-icon.png><link rel=mask-icon href=https://awethon.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.101.0"><meta property="og:title" content="Different ways to implement wrappers in Scala"><meta property="og:description" content="The wrapper pattern (or the proxy pattern) is a useful way of adding extra logic to the methods of a class without changing it. It might be handy in scenarios where an application needs to be heavily instrumented and putting all the instrumentation in business logic will make code less readable. To be more specific, wrappers are useful for logging, metering, and tracing, but not limited to it. For example, it might be useful to set timeouts and retries in wrappers."><meta property="og:type" content="article"><meta property="og:url" content="https://awethon.github.io/posts/scala-wrappers/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-20T21:55:20+03:00"><meta property="article:modified_time" content="2022-08-01T00:25:20+03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Different ways to implement wrappers in Scala"><meta name=twitter:description content="The wrapper pattern (or the proxy pattern) is a useful way of adding extra logic to the methods of a class without changing it. It might be handy in scenarios where an application needs to be heavily instrumented and putting all the instrumentation in business logic will make code less readable. To be more specific, wrappers are useful for logging, metering, and tracing, but not limited to it. For example, it might be useful to set timeouts and retries in wrappers."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://awethon.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Different ways to implement wrappers in Scala","item":"https://awethon.github.io/posts/scala-wrappers/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Different ways to implement wrappers in Scala","name":"Different ways to implement wrappers in Scala","description":"The wrapper pattern (or the proxy pattern) is a useful way of adding extra logic to the methods of a class without changing it. It might be handy in scenarios where an application needs to be heavily instrumented and putting all the instrumentation in business logic will make code less readable. To be more specific, wrappers are useful for logging, metering, and tracing, but not limited to it. For example, it might be useful to set timeouts and retries in wrappers.","keywords":["scala"],"articleBody":"The wrapper pattern (or the proxy pattern) is a useful way of adding extra logic to the methods of a class without changing it. It might be handy in scenarios where an application needs to be heavily instrumented and putting all the instrumentation in business logic will make code less readable. To be more specific, wrappers are useful for logging, metering, and tracing, but not limited to it. For example, it might be useful to set timeouts and retries in wrappers. However, transforming arguments or return value in a wrapper is considered to be an anti-pattern.\nScala is a great language with many features and a complex type system. Thus, it provides many ways to create wrappers, but not all of them will fit well in your application.\nTrait mixin One of the possible ways to create a wrapper is the trait mixin and abstract override techniques. Scala has a sophisticated mechanism of dynamic class composition (inheritance, technically speaking) that allows to build a class from pieces (traits). While abstract override allows a trait to inherit another trait and to provide the implementation of a method that is able to call implementation from parent.\nMechanism explanation\rSounds difficult but in fact it is easy to understand. // Our interface trait Printer { def print(): Unit } // Sub-trait of Printer that overrides print // and makes a call of a parent class implementation // without any knowledge of what parent it is going to be. // Thus, `abstract` keyword is needed. trait PrinterButCooler extends Printer { abstract override def print(): Unit = { printf(\"Hello \") super.print() printf(\"!\") } } // Implementation of Printer interface class PrinterImpl() extends Printer { override def print() = printf(\"World\") } new PrinterImpl().print() // Output: World // PrinterImpl becomes a super-class for PrinterButCooler (new PrinterImpl() with PrinterButCooler).print() // Output: Hello World! Using this mechanism, it's possible to compose many trait mixins together, and that's exactly what we need for our wrappers. Let’s introduce a simple dao interface - ItemDao. trait ItemDao { def upsert(item: Item): Unit def get(id: Id): Option[Item] } As an example, we’ll write logging of ItemDao methods, for that we need to create trait that extends ItemDao and override its methods with abstract modifier (see explanation above). trait LoggedItemDaoWrapper extends ItemDao with StrictLogging { abstract override def upsert(item: Item): Unit = { logger.info(s\"upsert($item) is called\") super.upsert(item) logger.info(s\"upsert($item) = ()\") } abstract override def get(id: Id): Option[Item] = { logger.info(s\"get($id) is called\") val result = super.get(id) logger.info(s\"get($id) = $result\") } } Then, we should initialize a class that implements ItemDao interface and add the wrapper we made into it. new ItemDaoImpl(...) extends LoggedItemDaoWrapper So far it looks clean and seems easy to understand. Unfortunately, code is going to become messy if there are dependencies to provide.\nTo show that, let’s make our trait return Future values: trait ItemDao { def upsert(item: Item): Future[Unit] def get(id: Id): Future[Option[Item]] } If a trait has an interface that returns Future, then ExecutionContext must be provided to our wrappers to be able to call map, flatMap, and other methods.\nMany developers create global single thread execution context to keep things simple, but let’s pretend I didn’t say that.\ntrait LoggedItemDaoWrapper extends ItemDao with StrictLogging { protected implicit def ec: ExecutionContext abstract override def upsert(item: Item): Future[Unit] = { super.upsert(item).map(_ =\u003e logger.info(s\"upsert($item) = ()\")) } abstract override def get(id: Id): Future[Option[Item]] = { super.get(id).map(result =\u003e logger.info(s\"get($id) = $result\")) } } val itemDao: ItemDao = new ItemDaoImpl(...) extends LoggedItemDaoWrapper { override def ec = yourEc } The code of initialization is not as clear as before because ExecutionContext has to be provided through the override def mechanism. Initialization order has to be kept in mind because it’s possible to get NullPointerException there.\nThe more dependencies are stacked together the worse the code looks.\nIt becomes even worse with Tagless Final. When we write wrappers using TF we want to keep the granularity of type classes, but when it comes to initialization, we’re doomed because different wrappers require different type class instances to be provided and we can only provide them by creating functions and overriding them in initialization code.\nHere’s an example of what TF code might look like: trait ItemDao[F[_]] { def upsert(item: Item): F[Unit] def get(id: Id): F[Option[Item]] } trait LoggedItemDaoWrapper[F[_]] extends ItemDao[F] with StrictLogging { implicit protected def mt: MonadThrow[F] abstract override def upsert(item: Item): F[Unit] = { super.upsert(item).attemptTap(...) } abstract override def get(id: Id): F[Option[Item]] = { super.get(id).attemptTap(...) } } val itemDao: ItemDao[F] = new ItemDaoImpl[F](...) extends LoggedItemDaoWrapper[F] with MeteredItemDaoWrapper[F] with TimeoutItemDaoWrapper[F] { override def mt: MonadThrow[F] = async override def at: ApplicativeError[F] = async override def concurrent: Concurrent[F] = async override def timer: Timer[F] = _timer override def gauge: Gauge = methodCallGauge } In order to reduce the amount of boilerplate and to make sure that the same dependencies have the same names, type class provider traits have to be implemented. trait MonadThrowProvider[F[_]] extends ApplicativeThrowProvider[F] { implicit protected def mt: MonadThrow[F] override implicit protected def at: ApplicativeError[F] = mt } trait LoggingProvider[F[_]] extends MonadThrowProvider[F] with StrictLogging trait LoggedItemDaoWrapper[F[_]] extends ItemDao[F] with LoggingProvider[F] { abstract override def upsert(item: Item): F[Unit] = { super.upsert(item).attemptTap(...) } abstract override def get(id: Id): F[Option[Item]] = { super.get(id).attemptTap(...) } } Composing all providers into an all-in-one provider might be a good idea to reduce boilerplate in the initialization code. trait AllInOneProvider[F[_]] extends MonadThrowProvider[F] with ConcurrentProvider[F] with TimerProvider[F] with ClockProvider[F] with PrometheusGaugeProvider { override def mt: MonadThrow[F] = async override def concurrent: Concurrent[F] = async override def timer: Timer[F] = _timer override def clock: Clock[F] = _clock override def gauge: Gauge = methodCallGauge } val itemDao: ItemDao[F] = new ItemDaoImpl[F](...) extends LoggedItemDaoWrapper[F] with MeteredItemDaoWrapper[F] with TimeoutItemDaoWrapper[F] with AllInOneProvider[F] We managed to hide all the ugly stuff behind AllInOneProvider trait and provider traits, but it’s hard to reason about provided dependencies and their initialization.\nInitialization of components itself looks clean, but there’s a strong feeling that Tagless Final went wrong and functional code shouldn’t be written this way.\nClassic wrapper class Writing a wrapper using a class is a standard way of doing it in OOP languages. The question is how well it is able to handle Tagless Final.\nLet’s take a look at how would wrappers look with plain, Future, and F[_] values. class LoggedItemDaoWrapper(itemDao: ItemDao) extends ItemDao with StrictLogging { override def upsert(item: Item): Unit = { logger.info(s\"upsert($item) is called\") itemDao.upsert(item) logger.info(s\"upsert($item) = ()\") } override def get(id: Id): Option[Item] = { logger.info(s\"get($id) is called\") val result = itemDao.get(id) logger.info(s\"get($id) = $result\") } } class LoggedItemDaoWrapper(itemDao: ItemDao)(implicit ec: ExecutionContext) extends ItemDao with StrictLogging { override def upsert(item: Item): Future[Unit] = { itemDao.upsert(item).map(_ =\u003e logger.info(s\"upsert($item) = ()\")) } override def get(id: Id): Future[Option[Item]] = { super.get(id).map(result =\u003e logger.info(s\"get($id) = $result\")) } } class LoggedItemDaoWrapper[F[_]: MonadThrow](itemDao: ItemDao[F]) extends ItemDao[F] with StrictLogging { override def upsert(item: Item): F[Unit] = { itemDao.upsert(item).attemptTap(...) } override def get(id: Id): F[Option[Item]] = { itemDao.get(id).attemptTap(...) } } Looks nice! Easy to read even with Tagless Final approach. But what about initialization?\nWell, having a constructor and implicit parameters reduces boilerplate significantly, composition instead of inheritance makes outcome easier to understand and control.\nval itemDao: ItemDao[F] = new TimeoutItemDaoWrapper[F](timeoutsConfig)( new MeteredItemDaoWrapper[F](gauge)( new LoggedItemDaoWrapper[F]( new ItemDaoImpl[F](...) ) ) ) Syntactic sugar for class wrappers Although initialization is in reverse order (compared to mixins) might be confusing.\nWith the power of Scala implicits, it is pretty easy to make code look like trait mixins are being added to a class.\nimplicit class WrapperHelper[A](private val a: A) extends AnyVal { def `with`[B \u003e: A](wrap: A =\u003e B): B = wrap(a) } Adding with extension method is helpful if you have to migrate your code from trait mixins or prefer to have a code with direct wrapping order to avoid confusion.\nTo achieve the best readability, make sure that wrappers have a companion with apply function with dependencies listed before to-be-wrapped class and that dependencies and class are separated with curring. class Wrapper[F[_]: TC1: TC2](dep1: Dep1, dep2: Dep2[F], o: MyClass[F]) extends MyClass[F] { ... } object Wrapper { def apply[F[_]: TC1: TC2](dep1: Dep1, dep2: Dep2[F])(o: MyClass[F]) = new Wrapper(dep1, dep2, o) } So initialization code will look like this: myClassImpl .`with`(Wrapper1(dep1, dep2)) .`with`(Wrapper2(dep3))\nTofu Mid Tofu is a scala library made by Tagless Final enthusiasts that boosts TF experience to new levels. It has many features worth checking out, but the feature we need for wrappers is Mid.\nMid is not an easy abstraction to understand. It is even harder to understand the deriving mechanism of type class ApplyK.\nNevertheless, it doesn’t make it hard to use. Mid is a function from the result of the original method to the result of the same type: F[A] =\u003e F[A].\n@derive(applyK) trait ItemDao[F[_]] { def upsert(item: Item): F[Unit] def get(id: Id): F[Option[Item]] } class LoggingItemDaoWrapper[F[_]: Sync] extends ItemDao[Mid[F, *]] with StrictLogging { // Effectful logging. You might want to use Tofu Logging instead or just impure logging. private def info(str: String): F[Unit] = Sync[F].delay(logger.info(str)) override def upsert(item: Item): Mid[F, Unit] = { upsert =\u003e info(s\"upserting $item\") *\u003e upsert \u003c* info(s\"upsert of $item is successful\") } override def get(id: Id): Mid[F, Option[Item]] = { get =\u003e info(s\"getting $id\") *\u003e get.flatTap(result =\u003e info(s\"get of $id is successful = $result\")) } } class TimeoutItemDaoWrapper[F[_]: Concurrent](timeoutValue: FiniteDuration) (implicit timer: Timer[F]) extends ItemDao[Mid[F, *]] { override def upsert(item: Item): Mid[F, Unit] = _.timeout(timeoutValue) override def get(id: Id): Mid[F, Option[Item]] = _.timeout(timeoutValue) } class NoOpItemDaoWrapper[F[_]] extends ItemDao[Mid[F, *]] { override def upsert(item: Item): Mid[F, Unit] = identity override def get(id: Id): Mid[F, Option[Item]] = identity } val service = new ItemDaoImpl[F](...) val logging = new LoggingItemDaoWrapper[F] val timeouts = new TimeoutItemDaoWrapper[F](timeoutValue) val noop = new NoOpItemDaoWrapper[F] // Execution order: // logging before // timeouts before // noop before // original method // noop after // timeouts after // logging after (logging |+| timeouts |+| noop).attach(service) As you can see code looks very clean without a need to pass arguments to the original method and make a call of it. While using Mid we’re manipulating with\nBut internal mechanism of Mid may not be clear.\nTo put things simple, all the mid wrappers are composed like mid2.andThen(mid1) and method call chain in composite wrapper looks like x =\u003e mid1.myMethod(mid2.myMethod(x)), where x is an effect of the original myMethod, like F[Option[Item]] After composition, Mid wrapper attaches to implementation. Attachment means application of implementation to a wrapper and as a result it returns wrapped instance of a class: compositeMid.apply(impl).\nSo basically, when you introduce a class with a type like ItemDao[Mid[F, *]], you introduce a wrapper, because Mid effect is a wrapper effect on type level.\nUnfortunately, Tofu Mid usability is limited to Tagless Final algebras due to ApplyK magic.\nKiller feature of inheritance-based wrapping (trait mixins) The killer feature of inheritance-based wrappers is that inner calls of public methods are calling wrapped versions of methods. In case of composition-based wrappers, if public method is called inside implementation then unwrapped version of it will be called.\nBelow, I wrote an example that will highlight described problem.\nCode example\rtrait Printer { def print(): Unit def threeTimesPrint(): Unit } trait LoggedPrinter extends Printer { abstract override def print(): Unit = { println(\"Print method is called\") super.print() } abstract override def threeTimesPrint(): Unit = { println(\"ThreeTimesPrint method is called\") super.threeTimesPrint() } } class LoggedPrinter2(printer: Printer) extends Printer { override def print(): Unit = { println(\"Print method is called\") printer.print() } override def threeTimesPrint(): Unit = { println(\"ThreeTimesPrint method is called\") printer.threeTimesPrint() } } class PrinterImpl() extends Printer { override def print() = println(\"A\") override def threeTimesPrint() = 1.to(3).foreach(_ =\u003e print()) } // Output: // ThreeTimesPrint method is called // Print method is called // A // Print method is called // A // Print method is called // A (new PrinterImpl() with LoggedPrinter).threeTimesPrint() // Output: // ThreeTimesPrint method is called // A // A // A (new LoggedPrinter2(new PrinterImpl())).threeTimesPrint() Pros and Cons At the end of the article, it might seem that choice is clear, however after digging into details, many limitations and downsides are found.\nTrait mixin Pros:\n+ Saves specific type after wrapping. new ItemDaoImpl(...) extends LoggedItemDao has type ItemDaoImpl with LoggedItemDao. So it is possible to use any methods from ItemDaoImpl.\n+ Only those methods that are to be wrapped need to be present in wrappers. If you have a trait with 10 methods but want to add logging to one of them, then only one abstract override of the method needs to be written in a mixin.\n+ Is able to do wrapped inner calls of public methods. + Doesn’t require any libraries to use.\n+ Well explained in scala books.\nCons:\n- Providing dependencies creates a lot of boilerplate.\n- Wrapping uses an inheritance mechanism. The order of initialization may not be clear.\n- Might lead to NPEs during initialization.\n- Looks ugly with Tagless Final.\nClassic wrapper class Pros:\n+ Easy-to-understand GOF pattern from OOP languages.\n+ Doesn’t get complicated no matter how many wrappers are composed.\n+ It’s possible to make initialization look like with mixins.\n+ Easy to use with Tagless Final.\n+ Doesn’t require any libraries to use.\nCons:\n- All the methods of a trait have to be overridden in a wrapper.\n- StrictLogging gets wrapper class instead of implementation by default. It makes it hard to find the source of log in case where wrapper is used for many implementations.\n- A wrapper loses implementation type after wrapping making it impossible to call methods specific to the implementation. - Is only able to unwrapped inner calls of public methods.\nTofu Mid Pros:\n+ No need to call an original method directly. Less boilerplate.\n+ Has DSL for initialization that is easy to use.\nCons:\n- ApplyK cannot be derived if at least one of the methods returns anything other than F[...]. So it won’t be derived if a trait has a constant method like def groupId: String or a method that returns fs2.Stream.\n- Mid usage is limited to TF algebras and only to them. - The annotation that derives ApplyK has to be added to a class or has to be derived manually. - One type parameter type has to be introduced to do initialization. It won’t work automatically with type KVDao[F[_], K, V] or similar.\n- All the methods of a trait have to be overridden in a wrapper. It’s much easier with Mid than with classic wrappers. Just use x =\u003e x or in other words identity is enough.\n- The same problem with StrictLogging as for classic wrapper class. Tofu provides Logging type class but its implementation is too specific.\n- A class that is wrapped with Mid wrapper loses original implementation type (the same as classic wrapper). Methods that are available only in implementation are unavailable after wrapping. - Is only able to unwrapped inner calls of public methods.\nConclusion Although usage of Mid reduces boilerplate in wrappers it adds boilerplate in ApplyK derivation and temporary one type parameter introduction cases.\nThe usability of Mid is very limited and cannot be used as a universal wrapping approach unless you have an ideal Tagless Final application which is a rare thing in reality.\nI’d recommend using classic wrapper classes as it is a readable and easy-to-understand solution, but unabilty to call wrapped methods inside implementation might be a huge downside sometimes.\n","wordCount":"2549","inLanguage":"en","datePublished":"2022-02-20T21:55:20+03:00","dateModified":"2022-08-01T00:25:20+03:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://awethon.github.io/posts/scala-wrappers/"},"publisher":{"@type":"Organization","name":"Awethon's Page","logo":{"@type":"ImageObject","url":"https://awethon.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://awethon.github.io/ accesskey=h title="Awethon's Page (Alt + H)">Awethon's Page</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://awethon.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://awethon.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://awethon.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Different ways to implement wrappers in Scala</h1><div class=post-meta>February 20, 2022
|&nbsp;<a href=https://github.com/Awethon/awethon.github.io/blob/master/content/posts/scala-wrappers.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>The wrapper pattern (or the proxy pattern) is a useful way of adding extra logic to the methods of a class without changing it. It might be handy in scenarios where an application needs to be heavily instrumented and putting all the instrumentation in business logic will make code less readable. To be more specific, wrappers are useful for logging, metering, and tracing, but not limited to it. For example, it might be useful to set timeouts and retries in wrappers. However, transforming arguments or return value in a wrapper is considered to be an anti-pattern.</p><p>Scala is a great language with many features and a complex type system. Thus, it provides many ways to create wrappers, but not all of them will fit well in your application.</p><h2 id=trait-mixin>Trait mixin<a hidden class=anchor aria-hidden=true href=#trait-mixin>#</a></h2><p>One of the possible ways to create a wrapper is the trait mixin and abstract override techniques. Scala has a sophisticated mechanism of dynamic class composition (inheritance, technically speaking) that allows to build a class from pieces (traits). While abstract override allows a trait to inherit another trait and to provide the implementation of a method that is able to call implementation from parent.</p><style type=text/css>.unselectable{-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}</style><details><summary class=unselectable><u>Mechanism explanation</u></summary><div style=padding-top:8px></div>Sounds difficult but in fact it is easy to understand.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#75715e>// Our interface
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>Printer</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> print<span style=color:#f92672>()</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Sub-trait of Printer that overrides print
</span></span></span><span style=display:flex><span><span style=color:#75715e>// and makes a call of a parent class implementation
</span></span></span><span style=display:flex><span><span style=color:#75715e>// without any knowledge of what parent it is going to be.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Thus, `abstract` keyword is needed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>PrinterButCooler</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Printer</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> print<span style=color:#f92672>()</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    printf<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Hello &#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span>print<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>    printf<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;!&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Implementation of Printer interface
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PrinterImpl</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Printer</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> print<span style=color:#f92672>()</span> <span style=color:#66d9ef>=</span> printf<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;World&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PrinterImpl</span><span style=color:#f92672>().</span>print<span style=color:#f92672>()</span> <span style=color:#75715e>// Output: World
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// PrinterImpl becomes a super-class for PrinterButCooler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PrinterImpl</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>PrinterButCooler</span><span style=color:#f92672>).</span>print<span style=color:#f92672>()</span> <span style=color:#f92672>//</span> <span style=color:#a6e22e>Output</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Hello</span> <span style=color:#66d9ef>World!</span></span></span></code></pre></div>Using this mechanism, it's possible to compose many trait mixins together, and that's exactly what we need for our wrappers.</details></br><p>Let&rsquo;s introduce a simple dao interface - ItemDao.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>ItemDao</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> upsert<span style=color:#f92672>(</span>item<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Item</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> get<span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Id</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Option</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Item</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span></span></span></code></pre></div><br>As an example, we&rsquo;ll write logging of ItemDao methods, for that we need to create trait that extends ItemDao and override its methods with abstract modifier (see explanation above).<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>LoggedItemDaoWrapper</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>ItemDao</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>StrictLogging</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> upsert<span style=color:#f92672>(</span>item<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Item</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    logger<span style=color:#f92672>.</span>info<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;upsert(</span><span style=color:#e6db74>$item</span><span style=color:#e6db74>) is called&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span>upsert<span style=color:#f92672>(</span>item<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    logger<span style=color:#f92672>.</span>info<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;upsert(</span><span style=color:#e6db74>$item</span><span style=color:#e6db74>) = ()&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> get<span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Id</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Option</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Item</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    logger<span style=color:#f92672>.</span>info<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;get(</span><span style=color:#e6db74>$id</span><span style=color:#e6db74>) is called&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> result <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span>get<span style=color:#f92672>(</span>id<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    logger<span style=color:#f92672>.</span>info<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;get(</span><span style=color:#e6db74>$id</span><span style=color:#e6db74>) = </span><span style=color:#e6db74>$result</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span></span></span></code></pre></div><br>Then, we should initialize a class that implements ItemDao interface and add the wrapper we made into it.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ItemDaoImpl</span><span style=color:#f92672>(...)</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>LoggedItemDaoWrapper</span></span></span></code></pre></div><br>So far it looks clean and seems easy to understand. Unfortunately, code is going to become messy if there are dependencies to provide.<br>To show that, let&rsquo;s make our trait return <code>Future</code> values:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>ItemDao</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> upsert<span style=color:#f92672>(</span>item<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Item</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Future</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> get<span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Id</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Future</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Option</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Item</span><span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span></span></span></code></pre></div><br>If a trait has an interface that returns <code>Future</code>, then <code>ExecutionContext</code> must be provided to our wrappers to be able to call <code>map</code>, <code>flatMap</code>, and other methods.<br>Many developers create global single thread execution context to keep things simple, but let&rsquo;s pretend I didn&rsquo;t say that.</p><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>LoggedItemDaoWrapper</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>ItemDao</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>StrictLogging</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>def</span> ec<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>ExecutionContext</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> upsert<span style=color:#f92672>(</span>item<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Item</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Future</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span>upsert<span style=color:#f92672>(</span>item<span style=color:#f92672>).</span>map<span style=color:#f92672>(</span><span style=color:#66d9ef>_</span> <span style=color:#66d9ef>=&gt;</span> logger<span style=color:#f92672>.</span>info<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;upsert(</span><span style=color:#e6db74>$item</span><span style=color:#e6db74>) = ()&#34;</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> get<span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Id</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Future</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Option</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Item</span><span style=color:#f92672>]]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span>get<span style=color:#f92672>(</span>id<span style=color:#f92672>).</span>map<span style=color:#f92672>(</span>result <span style=color:#66d9ef>=&gt;</span> logger<span style=color:#f92672>.</span>info<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;get(</span><span style=color:#e6db74>$id</span><span style=color:#e6db74>) = </span><span style=color:#e6db74>$result</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> itemDao<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>ItemDao</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ItemDaoImpl</span><span style=color:#f92672>(...)</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>LoggedItemDaoWrapper</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> ec <span style=color:#66d9ef>=</span> yourEc
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span></span></span></code></pre></div><br>The code of initialization is not as clear as before because <code>ExecutionContext</code> has to be provided through the <code>override def</code> mechanism. Initialization order has to be kept in mind because it&rsquo;s possible to get <code>NullPointerException</code> there.<br>The more dependencies are stacked together the worse the code looks.</p><p>It becomes even worse with Tagless Final. When we write wrappers using TF we want to keep the granularity of type classes, but when it comes to initialization, we&rsquo;re doomed because different wrappers require different type class instances to be provided and we can only provide them by creating functions and overriding them in initialization code.</p><p>Here&rsquo;s an example of what TF code might look like:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>ItemDao</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> upsert<span style=color:#f92672>(</span>item<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Item</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> get<span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Id</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Option</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Item</span><span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>LoggedItemDaoWrapper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]]</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>ItemDao</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>StrictLogging</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>def</span> mt<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>MonadThrow</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> upsert<span style=color:#f92672>(</span>item<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Item</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span>upsert<span style=color:#f92672>(</span>item<span style=color:#f92672>).</span>attemptTap<span style=color:#f92672>(...)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> get<span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Id</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Option</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Item</span><span style=color:#f92672>]]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span>get<span style=color:#f92672>(</span>id<span style=color:#f92672>).</span>attemptTap<span style=color:#f92672>(...)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> itemDao<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>ItemDao</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ItemDaoImpl</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>](...)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>LoggedItemDaoWrapper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>MeteredItemDaoWrapper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>TimeoutItemDaoWrapper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> mt<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>MonadThrow</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> async
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> at<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>ApplicativeError</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> async
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> concurrent<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Concurrent</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> async
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> timer<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Timer</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>_timer</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> gauge<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Gauge</span> <span style=color:#f92672>=</span> methodCallGauge
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> </span></span></code></pre></div><br>In order to reduce the amount of boilerplate and to make sure that the same dependencies have the same names, type class provider traits have to be implemented.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>MonadThrowProvider</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]]</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>ApplicativeThrowProvider</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>def</span> mt<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>MonadThrow</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>def</span> at<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>ApplicativeError</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> mt
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>LoggingProvider</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]]</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>MonadThrowProvider</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>StrictLogging</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>LoggedItemDaoWrapper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]]</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>ItemDao</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>LoggingProvider</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> upsert<span style=color:#f92672>(</span>item<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Item</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span>upsert<span style=color:#f92672>(</span>item<span style=color:#f92672>).</span>attemptTap<span style=color:#f92672>(...)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> get<span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Id</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Option</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Item</span><span style=color:#f92672>]]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span>get<span style=color:#f92672>(</span>id<span style=color:#f92672>).</span>attemptTap<span style=color:#f92672>(...)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span></span></span></code></pre></div><br>Composing all providers into an all-in-one provider might be a good idea to reduce boilerplate in the initialization code.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>AllInOneProvider</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>MonadThrowProvider</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>ConcurrentProvider</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>TimerProvider</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>ClockProvider</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>PrometheusGaugeProvider</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> mt<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>MonadThrow</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> async
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> concurrent<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Concurrent</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> async
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> timer<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Timer</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>_timer</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> clock<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Clock</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>_clock</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> gauge<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Gauge</span> <span style=color:#f92672>=</span> methodCallGauge
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> itemDao<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>ItemDao</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ItemDaoImpl</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>](...)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>LoggedItemDaoWrapper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>MeteredItemDaoWrapper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>TimeoutItemDaoWrapper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>AllInOneProvider</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span></span></span></code></pre></div><br>We managed to hide all the ugly stuff behind AllInOneProvider trait and provider traits, but it&rsquo;s hard to reason about provided dependencies and their initialization.<br>Initialization of components itself looks clean, but there&rsquo;s a strong feeling that Tagless Final went wrong and functional code shouldn&rsquo;t be written this way.</p><h2 id=classic-wrapper-class>Classic wrapper class<a hidden class=anchor aria-hidden=true href=#classic-wrapper-class>#</a></h2><p>Writing a wrapper using a class is a standard way of doing it in OOP languages. The question is how well it is able to handle Tagless Final.<br>Let&rsquo;s take a look at how would wrappers look with plain, <code>Future</code>, and <code>F[_]</code> values.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LoggedItemDaoWrapper</span><span style=color:#f92672>(</span>itemDao<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>ItemDao</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>ItemDao</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>StrictLogging</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> upsert<span style=color:#f92672>(</span>item<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Item</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    logger<span style=color:#f92672>.</span>info<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;upsert(</span><span style=color:#e6db74>$item</span><span style=color:#e6db74>) is called&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    itemDao<span style=color:#f92672>.</span>upsert<span style=color:#f92672>(</span>item<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    logger<span style=color:#f92672>.</span>info<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;upsert(</span><span style=color:#e6db74>$item</span><span style=color:#e6db74>) = ()&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> get<span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Id</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Option</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Item</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    logger<span style=color:#f92672>.</span>info<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;get(</span><span style=color:#e6db74>$id</span><span style=color:#e6db74>) is called&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> result <span style=color:#66d9ef>=</span> itemDao<span style=color:#f92672>.</span>get<span style=color:#f92672>(</span>id<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    logger<span style=color:#f92672>.</span>info<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;get(</span><span style=color:#e6db74>$id</span><span style=color:#e6db74>) = </span><span style=color:#e6db74>$result</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LoggedItemDaoWrapper</span><span style=color:#f92672>(</span>itemDao<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>ItemDao</span><span style=color:#f92672>)(</span><span style=color:#66d9ef>implicit</span> ec<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>ExecutionContext</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>ItemDao</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>StrictLogging</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> upsert<span style=color:#f92672>(</span>item<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Item</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Future</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    itemDao<span style=color:#f92672>.</span>upsert<span style=color:#f92672>(</span>item<span style=color:#f92672>).</span>map<span style=color:#f92672>(</span><span style=color:#66d9ef>_</span> <span style=color:#66d9ef>=&gt;</span> logger<span style=color:#f92672>.</span>info<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;upsert(</span><span style=color:#e6db74>$item</span><span style=color:#e6db74>) = ()&#34;</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> get<span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Id</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Future</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Option</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Item</span><span style=color:#f92672>]]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span>get<span style=color:#f92672>(</span>id<span style=color:#f92672>).</span>map<span style=color:#f92672>(</span>result <span style=color:#66d9ef>=&gt;</span> logger<span style=color:#f92672>.</span>info<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;get(</span><span style=color:#e6db74>$id</span><span style=color:#e6db74>) = </span><span style=color:#e6db74>$result</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LoggedItemDaoWrapper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>MonadThrow</span><span style=color:#f92672>](</span>itemDao<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>ItemDao</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>ItemDao</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>StrictLogging</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> upsert<span style=color:#f92672>(</span>item<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Item</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    itemDao<span style=color:#f92672>.</span>upsert<span style=color:#f92672>(</span>item<span style=color:#f92672>).</span>attemptTap<span style=color:#f92672>(...)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> get<span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Id</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Option</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Item</span><span style=color:#f92672>]]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    itemDao<span style=color:#f92672>.</span>get<span style=color:#f92672>(</span>id<span style=color:#f92672>).</span>attemptTap<span style=color:#f92672>(...)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span></span></span></code></pre></div><br>Looks nice! Easy to read even with Tagless Final approach. But what about initialization?<br>Well, having a constructor and implicit parameters reduces boilerplate significantly, composition instead of inheritance makes outcome easier to understand and control.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>val</span> itemDao<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>ItemDao</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TimeoutItemDaoWrapper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>](</span>timeoutsConfig<span style=color:#f92672>)(</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MeteredItemDaoWrapper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>](</span>gauge<span style=color:#f92672>)(</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>LoggedItemDaoWrapper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>](</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ItemDaoImpl</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>](...)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>)</span></span></span></code></pre></div><h3 id=syntactic-sugar-for-class-wrappers>Syntactic sugar for class wrappers<a hidden class=anchor aria-hidden=true href=#syntactic-sugar-for-class-wrappers>#</a></h3><p>Although initialization is in reverse order (compared to mixins) might be confusing.<br>With the power of Scala implicits, it is pretty easy to make code look like trait mixins are being added to a class.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>WrapperHelper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>A</span><span style=color:#f92672>](</span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> a<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>A</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>AnyVal</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> `with`<span style=color:#f92672>[</span><span style=color:#66d9ef>B</span> <span style=color:#66d9ef>&gt;:</span> <span style=color:#66d9ef>A</span><span style=color:#f92672>](</span>wrap<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>A</span> <span style=color:#f92672>=&gt;</span> B<span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>B</span> <span style=color:#f92672>=</span> wrap<span style=color:#f92672>(</span>a<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span></span></span></code></pre></div><p><br>Adding <code>with</code> extension method is helpful if you have to migrate your code from trait mixins or prefer to have a code with direct wrapping order to avoid confusion.<br>To achieve the best readability, make sure that wrappers have a companion with <code>apply</code> function with dependencies listed before to-be-wrapped class and that dependencies and class are separated with curring.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Wrapper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>TC1:</span> <span style=color:#66d9ef>TC2</span><span style=color:#f92672>](</span>dep1<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Dep1</span><span style=color:#f92672>,</span> dep2<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Dep2</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>],</span> o<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>MyClass</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>])</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>MyClass</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#f92672>{</span> <span style=color:#f92672>...</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>object</span> <span style=color:#a6e22e>Wrapper</span> <span style=color:#f92672>{</span> <span style=color:#66d9ef>def</span> apply<span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>TC1:</span> <span style=color:#66d9ef>TC2</span><span style=color:#f92672>](</span>dep1<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Dep1</span><span style=color:#f92672>,</span> dep2<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Dep2</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>])(</span>o<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>MyClass</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>])</span> <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Wrapper</span><span style=color:#f92672>(</span>dep1<span style=color:#f92672>,</span> dep2<span style=color:#f92672>,</span> o<span style=color:#f92672>)</span> <span style=color:#f92672>}</span></span></span></code></pre></div><br>So initialization code will look like this:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>myClassImpl
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span>`with`<span style=color:#f92672>(</span><span style=color:#a6e22e>Wrapper1</span><span style=color:#f92672>(</span>dep1<span style=color:#f92672>,</span> dep2<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span>`with`<span style=color:#f92672>(</span><span style=color:#a6e22e>Wrapper2</span><span style=color:#f92672>(</span>dep3<span style=color:#f92672>))</span></span></span></code></pre></div></p><h2 id=tofu-mid>Tofu Mid<a hidden class=anchor aria-hidden=true href=#tofu-mid>#</a></h2><p>Tofu is a scala library made by Tagless Final enthusiasts that boosts TF experience to new levels. It has many features worth checking out, but the feature we need for wrappers is <a href=https://docs.tofu.tf/docs/mid>Mid</a>.</p><p>Mid is not an easy abstraction to understand. It is even harder to understand the deriving mechanism of type class <code>ApplyK</code>.<br>Nevertheless, it doesn&rsquo;t make it hard to use. Mid is a function from the result of the original method to the result of the same type: <code>F[A] => F[A]</code>.</p><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#a6e22e>@derive</span><span style=color:#f92672>(</span>applyK<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>ItemDao</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> upsert<span style=color:#f92672>(</span>item<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Item</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> get<span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Id</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Option</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Item</span><span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LoggingItemDaoWrapper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Sync</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>ItemDao</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Mid</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>*</span><span style=color:#f92672>]]</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>StrictLogging</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Effectful logging. You might want to use Tofu Logging instead or just impure logging.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>def</span> info<span style=color:#f92672>(</span>str<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>Sync</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>].</span>delay<span style=color:#f92672>(</span>logger<span style=color:#f92672>.</span>info<span style=color:#f92672>(</span>str<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> upsert<span style=color:#f92672>(</span>item<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Item</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Mid</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>{</span> upsert <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>    info<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;upserting </span><span style=color:#e6db74>$item</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>*&gt;</span> upsert <span style=color:#f92672>&lt;*</span> info<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;upsert of </span><span style=color:#e6db74>$item</span><span style=color:#e6db74> is successful&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> get<span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Id</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Mid</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>Option</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Item</span><span style=color:#f92672>]]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>{</span> get <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>    info<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;getting </span><span style=color:#e6db74>$id</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>*&gt;</span> get<span style=color:#f92672>.</span>flatTap<span style=color:#f92672>(</span>result <span style=color:#66d9ef>=&gt;</span> info<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;get of </span><span style=color:#e6db74>$id</span><span style=color:#e6db74> is successful = </span><span style=color:#e6db74>$result</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TimeoutItemDaoWrapper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Concurrent</span><span style=color:#f92672>](</span>timeoutValue<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>FiniteDuration</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                                             <span style=color:#f92672>(</span><span style=color:#66d9ef>implicit</span> timer<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Timer</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>])</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>ItemDao</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Mid</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>*</span><span style=color:#f92672>]]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> upsert<span style=color:#f92672>(</span>item<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Item</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Mid</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>_</span><span style=color:#f92672>.</span>timeout<span style=color:#f92672>(</span>timeoutValue<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> get<span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Id</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Mid</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>Option</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Item</span><span style=color:#f92672>]]</span> <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>_</span><span style=color:#f92672>.</span>timeout<span style=color:#f92672>(</span>timeoutValue<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NoOpItemDaoWrapper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]]</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>ItemDao</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Mid</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>*</span><span style=color:#f92672>]]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> upsert<span style=color:#f92672>(</span>item<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Item</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Mid</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> identity
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> get<span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Id</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Mid</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>Option</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Item</span><span style=color:#f92672>]]</span> <span style=color:#66d9ef>=</span> identity
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> service  <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ItemDaoImpl</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>](...)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> logging  <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>LoggingItemDaoWrapper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> timeouts <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TimeoutItemDaoWrapper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>](</span>timeoutValue<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> noop     <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>NoOpItemDaoWrapper</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Execution order:
</span></span></span><span style=display:flex><span><span style=color:#75715e>// logging before
</span></span></span><span style=display:flex><span><span style=color:#75715e>// timeouts before
</span></span></span><span style=display:flex><span><span style=color:#75715e>// noop before
</span></span></span><span style=display:flex><span><span style=color:#75715e>// original method
</span></span></span><span style=display:flex><span><span style=color:#75715e>// noop after
</span></span></span><span style=display:flex><span><span style=color:#75715e>// timeouts after
</span></span></span><span style=display:flex><span><span style=color:#75715e>// logging after
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>(</span>logging <span style=color:#f92672>|+|</span> timeouts <span style=color:#f92672>|+|</span> noop<span style=color:#f92672>).</span>attach<span style=color:#f92672>(</span>service<span style=color:#f92672>)</span></span></span></code></pre></div><br>As you can see code looks very clean without a need to pass arguments to the original method and make a call of it. While using <code>Mid</code> we&rsquo;re manipulating with<br>But internal mechanism of Mid may not be clear.</p><p>To put things simple, all the mid wrappers are composed like <code>mid2.andThen(mid1)</code> and method call chain in composite wrapper looks like <code>x => mid1.myMethod(mid2.myMethod(x))</code>, where x is an effect of the original <code>myMethod</code>, like <code>F[Option[Item]]</code>
After composition, Mid wrapper attaches to implementation.
Attachment means application of implementation to a wrapper and as a result it returns wrapped instance of a class: <code>compositeMid.apply(impl)</code>.<br>So basically, when you introduce a class with a type like <code>ItemDao[Mid[F, *]]</code>, you introduce a wrapper, because Mid effect is a wrapper effect on type level.</p><p>Unfortunately, Tofu Mid usability is limited to Tagless Final algebras due to <code>ApplyK</code> magic.</p><h2 id=killer-feature-of-inheritance-based-wrapping-trait-mixins>Killer feature of inheritance-based wrapping (trait mixins)<a hidden class=anchor aria-hidden=true href=#killer-feature-of-inheritance-based-wrapping-trait-mixins>#</a></h2><p>The killer feature of inheritance-based wrappers is that inner calls of public methods are calling wrapped versions of methods. In case of composition-based wrappers, if public method is called inside implementation then unwrapped version of it will be called.</p><p>Below, I wrote an example that will highlight described problem.</p><style type=text/css>.unselectable{-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}</style><details><summary class=unselectable><u>Code example</u></summary><div style=padding-top:8px></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>Printer</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> print<span style=color:#f92672>()</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> threeTimesPrint<span style=color:#f92672>()</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>LoggedPrinter</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Printer</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> print<span style=color:#f92672>()</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    println<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Print method is called&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span>print<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> threeTimesPrint<span style=color:#f92672>()</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    println<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ThreeTimesPrint method is called&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span>threeTimesPrint<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LoggedPrinter2</span><span style=color:#f92672>(</span>printer<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Printer</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Printer</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> print<span style=color:#f92672>()</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    println<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Print method is called&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    printer<span style=color:#f92672>.</span>print<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> threeTimesPrint<span style=color:#f92672>()</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    println<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ThreeTimesPrint method is called&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    printer<span style=color:#f92672>.</span>threeTimesPrint<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PrinterImpl</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Printer</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> print<span style=color:#f92672>()</span> <span style=color:#66d9ef>=</span> println<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;A&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> threeTimesPrint<span style=color:#f92672>()</span> <span style=color:#66d9ef>=</span> <span style=color:#ae81ff>1.</span>to<span style=color:#f92672>(</span><span style=color:#ae81ff>3</span><span style=color:#f92672>).</span>foreach<span style=color:#f92672>(</span><span style=color:#66d9ef>_</span> <span style=color:#66d9ef>=&gt;</span> print<span style=color:#f92672>())</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Output:
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ThreeTimesPrint method is called
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Print method is called
</span></span></span><span style=display:flex><span><span style=color:#75715e>// A
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Print method is called
</span></span></span><span style=display:flex><span><span style=color:#75715e>// A
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Print method is called
</span></span></span><span style=display:flex><span><span style=color:#75715e>// A
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PrinterImpl</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>LoggedPrinter</span><span style=color:#f92672>).</span>threeTimesPrint<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Output:
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ThreeTimesPrint method is called
</span></span></span><span style=display:flex><span><span style=color:#75715e>// A
</span></span></span><span style=display:flex><span><span style=color:#75715e>// A
</span></span></span><span style=display:flex><span><span style=color:#75715e>// A
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>LoggedPrinter2</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PrinterImpl</span><span style=color:#f92672>())).</span>threeTimesPrint<span style=color:#f92672>()</span></span></span></code></pre></div></details></br><h2 id=pros-and-cons>Pros and Cons<a hidden class=anchor aria-hidden=true href=#pros-and-cons>#</a></h2><p>At the end of the article, it might seem that choice is clear, however after digging into details, many limitations and downsides are found.</p><h3 id=trait-mixin-1>Trait mixin<a hidden class=anchor aria-hidden=true href=#trait-mixin-1>#</a></h3><p>Pros:<br><strong>+</strong> Saves specific type after wrapping. <code>new ItemDaoImpl(...) extends LoggedItemDao</code> has type <code>ItemDaoImpl with LoggedItemDao</code>. So it is possible to use any methods from <code>ItemDaoImpl</code>.<br><strong>+</strong> Only those methods that are to be wrapped need to be present in wrappers. If you have a trait with 10 methods but want to add logging to one of them, then only one abstract override of the method needs to be written in a mixin.<br><strong>+</strong> Is able to do wrapped inner calls of public methods.
<strong>+</strong> Doesn&rsquo;t require any libraries to use.<br><strong>+</strong> Well explained in scala books.</p><p>Cons:<br><strong>-</strong> Providing dependencies creates a lot of boilerplate.<br><strong>-</strong> Wrapping uses an inheritance mechanism. The order of initialization may not be clear.<br><strong>-</strong> Might lead to NPEs during initialization.<br><strong>-</strong> Looks ugly with Tagless Final.</p><h3 id=classic-wrapper-class-1>Classic wrapper class<a hidden class=anchor aria-hidden=true href=#classic-wrapper-class-1>#</a></h3><p>Pros:<br><strong>+</strong> Easy-to-understand GOF pattern from OOP languages.<br><strong>+</strong> Doesn&rsquo;t get complicated no matter how many wrappers are composed.<br><strong>+</strong> It&rsquo;s possible to make initialization look like with mixins.<br><strong>+</strong> Easy to use with Tagless Final.<br><strong>+</strong> Doesn&rsquo;t require any libraries to use.</p><p>Cons:<br><strong>-</strong> All the methods of a trait have to be overridden in a wrapper.<br><strong>-</strong> StrictLogging gets wrapper class instead of implementation by default. It makes it hard to find the source of log in case where wrapper is used for many implementations.<br><strong>-</strong> A wrapper loses implementation type after wrapping making it impossible to call methods specific to the implementation.
<strong>-</strong> Is only able to unwrapped inner calls of public methods.</p><h3 id=tofu-mid-1>Tofu Mid<a hidden class=anchor aria-hidden=true href=#tofu-mid-1>#</a></h3><p>Pros:<br><strong>+</strong> No need to call an original method directly. Less boilerplate.<br><strong>+</strong> Has DSL for initialization that is easy to use.</p><p>Cons:<br><strong>-</strong> <code>ApplyK</code> cannot be derived if at least one of the methods returns anything other than <code>F[...]</code>. So it won&rsquo;t be derived if a trait has a constant method like <code>def groupId: String</code> or a method that returns <code>fs2.Stream</code>.<br><strong>-</strong> <code>Mid</code> usage is limited to TF algebras and only to them.
<strong>-</strong> The annotation that derives <code>ApplyK</code> has to be added to a class or has to be derived manually.
<strong>-</strong> One type parameter type has to be introduced to do initialization. It won&rsquo;t work automatically with type <code>KVDao[F[_], K, V]</code> or similar.<br><strong>-</strong> All the methods of a trait have to be overridden in a wrapper. It&rsquo;s much easier with <code>Mid</code> than with classic wrappers. Just use <code>x => x</code> or in other words <code>identity</code> is enough.<br><strong>-</strong> The same problem with StrictLogging as for classic wrapper class. Tofu provides Logging type class but its implementation is too specific.<br><strong>-</strong> A class that is wrapped with <code>Mid</code> wrapper loses original implementation type (the same as classic wrapper). Methods that are available only in implementation are unavailable after wrapping.
<strong>-</strong> Is only able to unwrapped inner calls of public methods.</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>Although usage of <code>Mid</code> reduces boilerplate in wrappers it adds boilerplate in <code>ApplyK</code> derivation and temporary one type parameter introduction cases.<br>The usability of Mid is very limited and cannot be used as a universal wrapping approach unless you have an ideal Tagless Final application which is a rare thing in reality.</p><p>I&rsquo;d recommend using classic wrapper classes as it is a readable and easy-to-understand solution, but unabilty to call wrapped methods inside implementation might be a huge downside sometimes.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://awethon.github.io/tags/scala/>scala</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Different ways to implement wrappers in Scala on twitter" href="https://twitter.com/intent/tweet/?text=Different%20ways%20to%20implement%20wrappers%20in%20Scala&url=https%3a%2f%2fawethon.github.io%2fposts%2fscala-wrappers%2f&hashtags=scala"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Different ways to implement wrappers in Scala on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fawethon.github.io%2fposts%2fscala-wrappers%2f&title=Different%20ways%20to%20implement%20wrappers%20in%20Scala&summary=Different%20ways%20to%20implement%20wrappers%20in%20Scala&source=https%3a%2f%2fawethon.github.io%2fposts%2fscala-wrappers%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Different ways to implement wrappers in Scala on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fawethon.github.io%2fposts%2fscala-wrappers%2f&title=Different%20ways%20to%20implement%20wrappers%20in%20Scala"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Different ways to implement wrappers in Scala on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fawethon.github.io%2fposts%2fscala-wrappers%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Different ways to implement wrappers in Scala on whatsapp" href="https://api.whatsapp.com/send?text=Different%20ways%20to%20implement%20wrappers%20in%20Scala%20-%20https%3a%2f%2fawethon.github.io%2fposts%2fscala-wrappers%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Different ways to implement wrappers in Scala on telegram" href="https://telegram.me/share/url?text=Different%20ways%20to%20implement%20wrappers%20in%20Scala&url=https%3a%2f%2fawethon.github.io%2fposts%2fscala-wrappers%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://awethon.github.io/>Awethon's Page</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script defer src=/assets/js/highlight.min.e85ad0406048e8176e1c7661b25d5c69297ddfe41dc4124cf75ecb99a4f7b3d1.js integrity="sha256-6FrQQGBI6BduHHZhsl1caSl93+QdxBJM917LmaT3s9E=" onload=hljs.initHighlightingOnLoad()></script>
<script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById("menu").scrollLeft=localStorage.getItem("menu-scroll-position"))};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById("menu").scrollLeft)}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>